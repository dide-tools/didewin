#!/usr/bin/env bash
set -ex

TARGET_BASE=~/net/home/didehpc
DATE=$(date +%Y%m%d-%H%M%S)
TARGET=$TARGET_BASE/$DATE

if [ ! -f ~/.smbcredentials ]; then
    echo "Can't automatically run vignettes for you -- no credentials"
    exit 1
fi

if [ ! -d $(dirname $TARGET_BASE) ]; then
    echo "Can't automatically run vignettes for you -- missing directory"
    exit 1
fi

cp -r vignettes_src $TARGET
make -C $TARGET

# This would otherwise get picked up in the glob next so delete it
# before the copy
rm -f $TARGET/README.md

# Try and get edits into the right file by adding a header
header="DO NOT EDIT THIS FILE - see vignettes_src and make changes there"

for f in $TARGET/*.md; do
    sed "s/HEADER/$header/" $f > "vignettes/$(basename "$f" .md).Rmd"
done
